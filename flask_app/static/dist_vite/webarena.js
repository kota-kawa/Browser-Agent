import{c as Ee,j as e,r}from"./chunks/client-Cmjl_fXq.js";const E=window.__WEBARENA_APP_PROPS__||{},Me=E.browserUrl||"",A=E.envUrls||{},Re=Array.isArray(E.supportedSites)?E.supportedSites:[],re=20,S=l=>!l||!l.provider||!l.model?null:JSON.stringify({provider:l.provider,model:l.model}),Le=l=>l?l.split("_").map(b=>b.charAt(0).toUpperCase()+b.slice(1)).join(" "):"ALL",Pe=()=>{const[l,b]=r.useState([]),[ie,M]=r.useState(""),[le,H]=r.useState(!1),[i,J]=r.useState({supported:null,effective:!1,userEnabled:!0,loading:!0,error:""}),[ce,W]=r.useState(!1),[c,oe]=r.useState({shopping:A.shopping||"",shopping_admin:A.shopping_admin||"",gitlab:A.gitlab||"",reddit:A.reddit||""}),[de,z]=r.useState([]),[ue,K]=r.useState(!1),[V,G]=r.useState(""),[k,R]=r.useState(1),[pe,he]=r.useState(!0),[m,me]=r.useState(""),[L,P]=r.useState(null),[j,B]=r.useState(!1),[O,ge]=r.useState(""),[Q,xe]=r.useState(""),[ve,X]=r.useState(""),[fe,Y]=r.useState("var(--text-muted)"),x=r.useRef(null),[q,Z]=r.useState(!1),[U,_]=r.useState(!1),[ye,be]=r.useState("選択タスクを実行"),[o,p]=r.useState({type:"idle"}),n=r.useCallback((s,t,a)=>{X(s),t&&Y(t),x.current&&(clearTimeout(x.current),x.current=null),a&&(x.current=window.setTimeout(()=>{X(""),Y("var(--text-muted)"),x.current=null},a))},[]),ee=r.useCallback(async()=>{try{const t=await(await fetch("/api/models")).json(),a=Array.isArray(t)?t:Array.isArray(t.models)?t.models??[]:[];b(a);const h=!Array.isArray(t)&&typeof t.current=="object"?t.current??null:null,d=S(h);d&&a.some(v=>S(v)===d)?M(d):a.length&&M(S(a[0])||"")}catch(s){console.error(s),b([])}},[]),je=r.useCallback(async s=>{await fetch("/model_settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})},[]),T=r.useCallback(async()=>{try{const t=await(await fetch("/api/vision")).json();J({supported:!!t.model_supported,effective:!!t.effective,userEnabled:!!t.user_enabled,loading:!1,error:""})}catch(s){console.error("Failed to load vision state",s),J(t=>({...t,loading:!1,error:"スクリーンショット状態の取得に失敗しました。"}))}},[]),se=r.useCallback(async()=>{K(!0),G("");try{const s=m?`&site=${m}`:"",a=await(await fetch(`/webarena/tasks?page=${k}&per_page=${re}${s}`)).json();z(Array.isArray(a.tasks)?a.tasks:[]),he((a.tasks||[]).length>=re)}catch(s){console.error("Failed to load tasks",s),z([]),G("Failed to load tasks.")}finally{K(!1)}},[k,m]);r.useEffect(()=>{ee(),T()},[ee,T]),r.useEffect(()=>{se()},[se]),r.useEffect(()=>()=>{x.current&&(clearTimeout(x.current),x.current=null)},[]);const we=async s=>{const t=s.target.value;M(t);let a;try{a=JSON.parse(t)}catch{n("モデル設定の解析に失敗しました。","var(--accent-danger)",3e3);return}n("モデルを変更中...","var(--text-muted)"),H(!0);try{await je(a),n("モデルを変更しました。","var(--text-muted)",3e3)}catch{n("モデルの変更に失敗しました。","var(--accent-danger)",3e3)}finally{H(!1),T()}},Ne=async s=>{const t=s.target.checked;W(!0);try{await fetch("/api/vision",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:t})})}catch(a){console.error("Failed to update vision toggle",a),alert("スクリーンショット設定の更新に失敗しました。")}finally{W(!1),T()}},te=s=>{if(s==="custom"){B(!0),P(null);return}B(!1),P(s)},Se=s=>{const a=s.target.tagName;a==="INPUT"||a==="TEXTAREA"||te("custom")},ae=s=>{me(s||""),R(1),P(null),B(!1)},ke=async()=>{if(L===null&&!j){alert("タスクを選択してください。");return}const s={env_urls:{shopping:c.shopping,shopping_admin:c.shopping_admin,gitlab:c.gitlab,reddit:c.reddit}};if(j){if(!O.trim()){alert("カスタムタスクの指示を入力してください。");return}s.custom_task={intent:O,start_url:Q}}else s.task_id=L;m&&(s.selected_site=m),n("評価を実行中...","var(--accent-info)"),Z(!0),p({type:"single-running"});try{const t=await fetch("/webarena/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),a=await t.json();if(!t.ok)throw new Error(a.error||"Error running task");p({type:"single-result",result:a}),n("完了","var(--accent-success)")}catch(t){p({type:"error",message:t.message,prefix:"エラーが発生しました: "}),n("エラー","var(--accent-danger)")}finally{Z(!1),be("評価を実行")}},_e=async()=>{n("一括実行中...","var(--accent-info)"),_(!0),p({type:"blank"});let s=[];try{const d=m?`&site=${m}`:"";s=((await(await fetch(`/webarena/tasks?page=1&per_page=1000${d}`)).json()).tasks||[]).map(u=>u.task_id)}catch(d){p({type:"error",message:`タスクの取得に失敗しました: ${d.message}`,prefix:""}),n("エラー","var(--accent-danger)"),_(!1);return}if(!s.length){p({type:"error",message:"表示中のタスクがありません。",prefix:""}),n("エラー","var(--accent-danger)"),_(!1);return}const t=[];let a=0;const h=Date.now();p({type:"batch",batch:{status:"running",total:s.length,currentIndex:0,currentTaskId:null,results:[],successCount:0}});try{for(let f=0;f<s.length;f+=1){const y=s[f];p({type:"batch",batch:{status:"running",total:s.length,currentIndex:f+1,currentTaskId:y,results:[...t],successCount:a}});let N;try{const $=await fetch("/webarena/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({env_urls:{shopping:c.shopping,shopping_admin:c.shopping_admin,gitlab:c.gitlab,reddit:c.reddit},task_id:y,selected_site:m||void 0})}),F=await $.json();$.ok?N=F:N={task_id:y,success:!1,summary:F.error||`TASK ${y} の実行に失敗しました`,evaluation:"Batch runner recorded an error for this task.",steps:[]}}catch($){N={task_id:y,success:!1,summary:`エラー: ${$.message}`,evaluation:"Batch runner caught an exception.",steps:[]}}t.push(N),N.success&&(a+=1),p({type:"batch",batch:{status:"running",total:s.length,currentIndex:f+1,currentTaskId:y,results:[...t],successCount:a}})}const g=Date.now()-h,v=Math.floor(g/6e4),u=(g%6e4/1e3).toFixed(1),I=v>0?`${v}分 ${u}秒`:`${u}秒`;p({type:"batch",batch:{status:"complete",total:s.length,currentIndex:s.length,currentTaskId:null,results:[...t],successCount:a,timeText:I}});try{n("結果を保存中...","var(--accent-info)"),await fetch("/webarena/save_results",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({results:t})}),n("完了 (保存済み)","var(--accent-success)")}catch(f){console.error("Save failed",f),n("完了 (保存失敗)","var(--accent-success)")}}catch(d){const g=d;p({type:"batch",batch:{status:"error",total:s.length,currentIndex:t.length,currentTaskId:null,results:[...t],successCount:a,errorMessage:g.message}}),n("エラー","var(--accent-danger)")}finally{_(!1)}},C=s=>t=>{const a=t.target;oe(h=>({...h,[s]:a.value}))},Te=()=>{if(o.type==="single-running")return e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"var(--text-muted)"},children:e.jsx("i",{children:"Running task... check browser view"})});if(o.type==="error")return e.jsxs("div",{style:{color:"red",padding:"20px"},children:[o.prefix||"",o.message]});if(o.type==="single-result"){const s=o.result,t={padding:"16px",marginBottom:"16px",borderRadius:"12px",background:s.success?"#f0fdf4":"#fef2f2",border:`1px solid ${s.success?"#bbf7d0":"#fecaca"}`};return e.jsxs("div",{children:[e.jsxs("div",{style:t,children:[e.jsx("div",{style:{fontWeight:700,color:s.success?"#15803d":"#b91c1c",marginBottom:"8px"},children:s.success?"✓ 成功 (SUCCESS)":"✕ 失敗 (FAILURE)"}),e.jsx("div",{dangerouslySetInnerHTML:{__html:`<strong>Summary:</strong> ${s.summary||""}`}}),s.evaluation&&e.jsx("div",{style:{marginTop:"8px",paddingTop:"8px",borderTop:"1px dashed rgba(0,0,0,0.1)",fontSize:"0.9em"},dangerouslySetInnerHTML:{__html:`<strong>Details:</strong><br>${s.evaluation.replace(/\n/g,"<br>")}`}})]}),(s.steps||[]).map((a,h)=>e.jsx("div",{className:"wa-step",dangerouslySetInnerHTML:{__html:`<span class="wa-step-num">${a.step}.</span> ${a.content}`}},`${a.step}-${h}`))]})}if(o.type==="batch"){const s=o.batch,t=s.total||0,a=s.currentIndex||0,h=t>0?Math.max(5,Math.round(a/t*100)):0,d=s.status==="complete"?"完了":s.status==="error"?"エラー":"一括実行中",g=s.status==="complete"?`成功 ${s.successCount||0} / ${t} 件`:s.status==="error"?s.errorMessage:s.currentTaskId?`TASK ${s.currentTaskId} を実行中... (${a}/${t})`:`実行中... (${a}/${t})`,v=s.status==="complete"?e.jsxs("div",{className:"wa-batch-summary",children:[e.jsx("div",{className:"wa-batch-summary__title",children:"バッチ結果"}),e.jsxs("div",{className:"wa-batch-summary__stats",children:["成功: ",s.successCount||0," / ",t," | スコア:"," ",t?Math.round((s.successCount||0)/t*1e4)/100:0,"%",e.jsx("br",{}),"所要時間: ",s.timeText||""]})]}):null;return e.jsxs("div",{children:[v,e.jsxs("div",{className:"wa-progress-card",children:[e.jsxs("div",{className:"wa-progress-meta",children:[e.jsx("div",{className:"wa-progress-label",children:d}),e.jsxs("div",{className:"wa-progress-count",children:[e.jsx("span",{"data-progress-count":!0,children:a})," / ",t]})]}),e.jsx("div",{className:"wa-progress-bar",children:e.jsx("div",{className:`wa-progress-bar-fill${s.status==="complete"?" is-complete":s.status==="error"?" is-error":""}`,"data-progress-bar":!0,style:{width:s.status==="complete"||s.status==="error"?"100%":`${h}%`}})}),e.jsx("div",{className:"wa-progress-current","data-progress-current":!0,children:g})]}),(s.results||[]).map((u,I)=>e.jsxs("div",{className:"wa-task-result",children:[e.jsxs("div",{className:"wa-task-result__head",children:[e.jsxs("div",{className:"wa-task-result__title",children:["(",I+1,"/",t,") TASK ",u.task_id??""]}),e.jsx("span",{className:`wa-badge ${u.success?"wa-badge-success":"wa-badge-fail"}`,children:u.success?"SUCCESS":"FAIL"})]}),e.jsx("div",{className:"wa-task-result__summary",dangerouslySetInnerHTML:{__html:`<strong>Summary:</strong> ${u.summary||""}`}}),u.evaluation&&e.jsx("div",{className:"wa-task-result__evaluation",dangerouslySetInnerHTML:{__html:u.evaluation.replace(/\n/g,"<br>")}})]},u.task_id??I)),s.status==="error"&&e.jsxs("div",{className:"wa-task-result",children:[e.jsxs("div",{className:"wa-task-result__head",children:[e.jsx("div",{className:"wa-task-result__title",children:"バッチを中断しました"}),e.jsx("span",{className:"wa-badge wa-badge-fail",children:"ERROR"})]}),e.jsx("div",{className:"wa-task-result__summary",children:s.errorMessage||""})]})]})}return o.type==="blank"?null:e.jsx("p",{style:{color:"var(--text-muted)",textAlign:"center",marginTop:"20px"},children:"タスクを選択して「評価を実行」をクリックしてください。"})},D=r.useMemo(()=>{var t;if(o.type!=="single-result")return{visible:!1,text:"",className:"wa-badge"};const s=(t=o.result)==null?void 0:t.success;return{visible:!0,text:s?"SUCCESS":"FAILURE",className:`wa-badge ${s?"wa-badge-success":"wa-badge-fail"}`}},[o]),Ce=i.loading?"CHECKING":i.supported?"SUPPORTED":"UNSUPPORTED",Ie=`wa-badge ${i.loading?"wa-badge-pending":i.supported?"wa-badge-success":"wa-badge-fail"}`;let w="モデルがサポートしていればスクリーンショットを送信します。";i.error?w=i.error:i.loading||(i.supported?i.effective?w="スクリーンショットをモデルに送信しています。":w="スクリーンショット送信を停止中です。":w="選択中のモデルはスクリーンショット非対応です。GPT/Gemini/Claude 系のみ対応。");const $e=q||le||U,Ae=U;return e.jsxs("div",{className:"wa-layout",children:[e.jsxs("aside",{className:"wa-sidebar",children:[e.jsxs("div",{className:"wa-header",children:[e.jsx("h1",{children:"WebArena Eval"}),e.jsxs("a",{href:"/",className:"wa-back-link",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M19 12H5M12 19l-7-7 7-7"})}),"ホームに戻る"]})]}),e.jsxs("div",{className:"wa-section",children:[e.jsx("h4",{className:"wa-section-title",children:"評価モデル"}),e.jsx("div",{className:"model-selector-wrapper",children:e.jsx("select",{id:"model-selector",value:l.length?ie:void 0,onChange:we,children:l.length===0?e.jsx("option",{children:"Loading models..."}):l.map(s=>e.jsx("option",{value:S(s),children:s.label},S(s)||s.label))})})]}),e.jsxs("div",{className:"wa-section",children:[e.jsxs("div",{className:"wa-section-title",style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("span",{children:"スクリーンショット参照"}),e.jsx("span",{id:"vision-support-badge",className:Ie,children:Ce})]}),e.jsxs("label",{className:"wa-toggle",children:[e.jsx("input",{type:"checkbox",id:"vision-toggle",checked:i.userEnabled,disabled:i.loading||!i.supported||ce,onChange:Ne}),e.jsx("span",{className:"wa-toggle-slider","aria-hidden":"true"}),e.jsx("span",{className:"wa-toggle-label",id:"vision-toggle-label",children:i.userEnabled?"ON":"OFF"})]}),e.jsx("p",{id:"vision-hint",className:"wa-hint",children:w})]}),e.jsxs("details",{className:"wa-config-details",children:[e.jsx("summary",{children:"環境設定 (Base URLs)"}),e.jsxs("div",{className:"wa-config-content",children:[e.jsxs("div",{className:"wa-input-group",children:[e.jsx("label",{children:"Shopping"}),e.jsx("input",{type:"text",id:"url-shopping",className:"wa-input",value:c.shopping,onInput:C("shopping")})]}),e.jsxs("div",{className:"wa-input-group",children:[e.jsx("label",{children:"Admin"}),e.jsx("input",{type:"text",id:"url-admin",className:"wa-input",value:c.shopping_admin,onInput:C("shopping_admin")})]}),e.jsxs("div",{className:"wa-input-group",children:[e.jsx("label",{children:"GitLab"}),e.jsx("input",{type:"text",id:"url-gitlab",className:"wa-input",value:c.gitlab,onInput:C("gitlab")})]}),e.jsxs("div",{className:"wa-input-group",children:[e.jsx("label",{children:"Reddit"}),e.jsx("input",{type:"text",id:"url-reddit",className:"wa-input",value:c.reddit,onInput:C("reddit")})]})]})]}),e.jsxs("div",{className:"wa-section",children:[e.jsx("h4",{className:"wa-section-title",children:"環境で絞り込み"}),e.jsxs("div",{id:"site-filters",style:{display:"flex",gap:"6px",flexWrap:"wrap"},children:[e.jsx("button",{className:`wa-btn-chip${m===""?" active":""}`,"data-site":"",onClick:()=>ae(""),children:"ALL"}),Re.map(s=>e.jsx("button",{className:`wa-btn-chip${m===s?" active":""}`,"data-site":s,onClick:()=>ae(s),children:Le(s)},s))]})]}),e.jsxs("div",{className:"wa-section",style:{flex:1,minHeight:0,display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("h4",{className:"wa-section-title",children:"タスク一覧"}),e.jsxs("div",{className:"wa-pagination",children:[e.jsx("button",{id:"prev-page",className:"wa-btn-sm",disabled:k<=1,onClick:()=>R(s=>Math.max(s-1,1)),children:"<"}),e.jsx("span",{id:"page-indicator",style:{fontSize:"0.75rem",color:"var(--text-muted)",fontWeight:600,padding:"0 6px"},children:k}),e.jsx("button",{id:"next-page",className:"wa-btn-sm",disabled:!pe,onClick:()=>R(s=>s+1),children:">"})]})]}),e.jsx("div",{id:"task-list",className:"wa-task-list",style:{overflowY:"auto",padding:"4px"},children:ue?e.jsx("div",{style:{padding:"10px",color:"#94a3b8",textAlign:"center"},children:"Loading..."}):V?e.jsx("div",{style:{color:"red",padding:"10px"},children:V}):de.map(s=>e.jsxs("div",{className:`wa-task-card${L===s.task_id&&!j?" active":""}`,"data-id":s.task_id,onClick:()=>te(s.task_id),children:[e.jsxs("div",{className:"wa-task-id",children:["TASK ",s.task_id]}),e.jsx("div",{className:"wa-task-desc",title:s.intent,children:s.intent})]},s.task_id))}),e.jsxs("div",{className:`wa-task-card${j?" active":""}`,id:"custom-task-card",style:{marginTop:"10px",borderStyle:"dashed"},onClick:Se,children:[e.jsx("div",{className:"wa-task-id",children:"CUSTOM TASK"}),e.jsx("div",{style:{fontSize:"0.85rem",fontWeight:500},children:"カスタムタスクを実行"}),e.jsxs("div",{id:"custom-inputs",style:{marginTop:"10px",display:j?"block":"none"},children:[e.jsx("input",{type:"text",id:"custom-url",className:"wa-input",placeholder:"開始URL",style:{marginBottom:"8px"},value:Q,onInput:s=>xe(s.target.value)}),e.jsx("textarea",{id:"custom-intent",className:"wa-input",rows:3,placeholder:"指示内容を入力...",value:O,onInput:s=>ge(s.target.value)})]})]})]}),e.jsxs("div",{style:{paddingTop:"10px"},children:[e.jsx("button",{id:"run-eval-btn",className:"control-button control-button--primary",style:{width:"100%",height:"46px",fontSize:"1rem",marginBottom:"8px"},disabled:$e,onClick:ke,children:q?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"connection-indicator","data-state":"connecting",children:e.jsx("span",{className:"dot"})}),"実行中..."]}):ye}),e.jsx("button",{id:"run-batch-btn",className:"control-button",style:{width:"100%",height:"42px",fontSize:"0.95rem",border:"1px solid var(--border-subtle)"},disabled:Ae,onClick:_e,children:U?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"connection-indicator","data-state":"connecting",children:e.jsx("span",{className:"dot"})}),"一括実行中..."]}):"表示中タスクを順番に実行"}),e.jsx("div",{id:"status-msg",style:{textAlign:"center",marginTop:"8px",fontSize:"0.8rem",color:fe,minHeight:"1.2em"},children:ve})]})]}),e.jsxs("main",{className:"wa-main-col",children:[e.jsx("div",{className:"wa-browser-container",children:e.jsx("iframe",{src:Me,title:"Remote Browser",style:{width:"100%",height:"100%",border:"none"}})}),e.jsxs("div",{className:"wa-results-container",children:[e.jsxs("div",{className:"wa-results-header",children:[e.jsx("h3",{children:"実行ログ / 結果"}),e.jsx("span",{id:"result-badge",className:D.className,style:{display:D.visible?"inline-flex":"none"},children:D.text})]}),e.jsx("div",{id:"logs",className:"wa-log-area",children:Te()})]})]})]})},ne=document.getElementById("root");ne&&Ee(ne).render(e.jsx(Pe,{}));
