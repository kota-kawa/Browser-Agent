name: Syntax Check

on:
  push:
  pull_request:

jobs:
  python-syntax:
    name: Python Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Python syntax
        run: |
          python - <<'PY'
          import pathlib
          import py_compile
          import subprocess
          import tempfile

          files = [
              pathlib.Path(path)
              for path in subprocess.check_output(['git', 'ls-files', '*.py'], text=True).splitlines()
              if path
          ]

          if not files:
              print('No Python files found.')
              raise SystemExit(0)

          errors = []
          with tempfile.TemporaryDirectory() as tmpdir:
              tmp_path = pathlib.Path(tmpdir)
              for idx, file in enumerate(files):
                  try:
                      py_compile.compile(str(file), cfile=str(tmp_path / f'{idx}.pyc'), doraise=True)
                  except py_compile.PyCompileError as exc:
                      errors.append(str(exc))

          if errors:
              print('\n'.join(errors))
              print(f'Found {len(errors)} Python syntax error(s).')
              raise SystemExit(1)

          print(f'Python syntax OK ({len(files)} files).')
          PY

  typescript-syntax:
    name: TypeScript Syntax Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: fastapi_app/frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate frontend paths
        run: |
          test -d fastapi_app/frontend
          test -f fastapi_app/frontend/package-lock.json

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: fastapi_app/frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci

      - name: Check TypeScript syntax
        run: npx tsc --project tsconfig.json --noEmit --noCheck
