import{c as Oe,j as e,r}from"./chunks/client-Cmjl_fXq.js";import{g as A,a as E,r as Le}from"./chunks/api-C7zj4pXc.js";const O=window.__WEBARENA_APP_PROPS__||{},Re=O.browserUrl||"",M=O.envUrls||{},Be=Array.isArray(O.supportedSites)?O.supportedSites:[],le=20,k=i=>!i||!i.provider||!i.model?null:JSON.stringify({provider:i.provider,model:i.model}),Pe=i=>i?i.split("_").map(y=>y.charAt(0).toUpperCase()+y.slice(1)).join(" "):"ALL",Ue=()=>{const[i,y]=r.useState([]),[ce,L]=r.useState(""),[oe,J]=r.useState(!1),[l,W]=r.useState({supported:null,effective:!1,userEnabled:!0,loading:!0,error:""}),[de,z]=r.useState(!1),[c,ue]=r.useState({shopping:M.shopping||"",shopping_admin:M.shopping_admin||"",gitlab:M.gitlab||"",reddit:M.reddit||""}),[pe,K]=r.useState([]),[he,V]=r.useState(!1),[G,Q]=r.useState(""),[S,R]=r.useState(1),[me,ge]=r.useState(!0),[h,xe]=r.useState(""),[B,P]=r.useState(null),[w,U]=r.useState(!1),[D,ve]=r.useState(""),[q,fe]=r.useState(""),[be,X]=r.useState(""),[ye,Y]=r.useState("var(--text-muted)"),x=r.useRef(null),[Z,ee]=r.useState(!1),[F,_]=r.useState(!1),[we,je]=r.useState("選択タスクを実行"),[o,u]=r.useState({type:"idle"}),n=r.useCallback((s,t,a)=>{X(s),t&&Y(t),x.current&&(clearTimeout(x.current),x.current=null),a&&(x.current=window.setTimeout(()=>{X(""),Y("var(--text-muted)"),x.current=null},a))},[]),se=r.useCallback(async()=>{try{const{data:s}=await A("/api/models",{throwOnNonOk:!1}),t=s,a=Array.isArray(t)?t:Array.isArray(t.models)?t.models??[]:[];y(a);const p=!Array.isArray(t)&&typeof t.current=="object"?t.current??null:null,d=k(p);d&&a.some(v=>k(v)===d)?L(d):a.length&&L(k(a[0])||"")}catch(s){console.error(s),y([])}},[]),Ne=r.useCallback(async s=>{await E("/model_settings",s,{parseJson:!1,throwOnNonOk:!1})},[]),T=r.useCallback(async()=>{try{const{data:s}=await A("/api/vision",{throwOnNonOk:!1});W({supported:!!s.model_supported,effective:!!s.effective,userEnabled:!!s.user_enabled,loading:!1,error:""})}catch(s){console.error("Failed to load vision state",s),W(t=>({...t,loading:!1,error:"スクリーンショット状態の取得に失敗しました。"}))}},[]),te=r.useCallback(async()=>{V(!0),Q("");try{const s=h?`&site=${h}`:"",{data:t}=await A(`/webarena/tasks?page=${S}&per_page=${le}${s}`,{throwOnNonOk:!1});K(Array.isArray(t.tasks)?t.tasks:[]),ge((t.tasks||[]).length>=le)}catch(s){console.error("Failed to load tasks",s),K([]),Q("Failed to load tasks.")}finally{V(!1)}},[S,h]);r.useEffect(()=>{se(),T()},[se,T]),r.useEffect(()=>{te()},[te]),r.useEffect(()=>()=>{x.current&&(clearTimeout(x.current),x.current=null)},[]);const ke=async s=>{const t=s.target.value;L(t);let a;try{a=JSON.parse(t)}catch{n("モデル設定の解析に失敗しました。","var(--accent-danger)",3e3);return}n("モデルを変更中...","var(--text-muted)"),J(!0);try{await Ne(a),n("モデルを変更しました。","var(--text-muted)",3e3)}catch{n("モデルの変更に失敗しました。","var(--accent-danger)",3e3)}finally{J(!1),T()}},Se=async s=>{const t=s.target.checked;z(!0);try{await E("/api/vision",{enabled:t},{parseJson:!1,throwOnNonOk:!1})}catch(a){console.error("Failed to update vision toggle",a),alert("スクリーンショット設定の更新に失敗しました。")}finally{z(!1),T()}},ae=s=>{if(s==="custom"){U(!0),P(null);return}U(!1),P(s)},_e=s=>{const a=s.target.tagName;a==="INPUT"||a==="TEXTAREA"||ae("custom")},re=s=>{xe(s||""),R(1),P(null),U(!1)},Te=async()=>{if(B===null&&!w){alert("タスクを選択してください。");return}const s={env_urls:{shopping:c.shopping,shopping_admin:c.shopping_admin,gitlab:c.gitlab,reddit:c.reddit}};if(w){if(!D.trim()){alert("カスタムタスクの指示を入力してください。");return}s.custom_task={intent:D,start_url:q}}else s.task_id=B;h&&(s.selected_site=h),n("評価を実行中...","var(--accent-info)"),ee(!0),u({type:"single-running"});try{const{data:t}=await E("/webarena/run",s,{errorMessage:"Error running task"});u({type:"single-result",result:t}),n("完了","var(--accent-success)")}catch(t){u({type:"error",message:t.message,prefix:"エラーが発生しました: "}),n("エラー","var(--accent-danger)")}finally{ee(!1),je("評価を実行")}},Ce=async()=>{n("一括実行中...","var(--accent-info)"),_(!0),u({type:"blank"});let s=[];try{const d=h?`&site=${h}`:"",{data:m}=await A(`/webarena/tasks?page=1&per_page=1000${d}`,{throwOnNonOk:!1});s=(m.tasks||[]).map(v=>v.task_id)}catch(d){u({type:"error",message:`タスクの取得に失敗しました: ${d.message}`,prefix:""}),n("エラー","var(--accent-danger)"),_(!1);return}if(!s.length){u({type:"error",message:"表示中のタスクがありません。",prefix:""}),n("エラー","var(--accent-danger)"),_(!1);return}const t=[];let a=0;const p=Date.now();u({type:"batch",batch:{status:"running",total:s.length,currentIndex:0,currentTaskId:null,results:[],successCount:0}});try{for(let f=0;f<s.length;f+=1){const b=s[f];u({type:"batch",batch:{status:"running",total:s.length,currentIndex:f+1,currentTaskId:b,results:[...t],successCount:a}});let N;try{const{data:$,response:ne}=await Le("/webarena/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({env_urls:{shopping:c.shopping,shopping_admin:c.shopping_admin,gitlab:c.gitlab,reddit:c.reddit},task_id:b,selected_site:h||void 0})},{throwOnNonOk:!1});ne.ok?N=$:N={task_id:b,success:!1,summary:$.error||`TASK ${b} の実行に失敗しました`,evaluation:"Batch runner recorded an error for this task.",steps:[]}}catch($){N={task_id:b,success:!1,summary:`エラー: ${$.message}`,evaluation:"Batch runner caught an exception.",steps:[]}}t.push(N),N.success&&(a+=1),u({type:"batch",batch:{status:"running",total:s.length,currentIndex:f+1,currentTaskId:b,results:[...t],successCount:a}})}const m=Date.now()-p,v=Math.floor(m/6e4),g=(m%6e4/1e3).toFixed(1),I=v>0?`${v}分 ${g}秒`:`${g}秒`;u({type:"batch",batch:{status:"complete",total:s.length,currentIndex:s.length,currentTaskId:null,results:[...t],successCount:a,timeText:I}});try{n("結果を保存中...","var(--accent-info)"),await E("/webarena/save_results",{results:t},{parseJson:!1,throwOnNonOk:!1}),n("完了 (保存済み)","var(--accent-success)")}catch(f){console.error("Save failed",f),n("完了 (保存失敗)","var(--accent-success)")}}catch(d){const m=d;u({type:"batch",batch:{status:"error",total:s.length,currentIndex:t.length,currentTaskId:null,results:[...t],successCount:a,errorMessage:m.message}}),n("エラー","var(--accent-danger)")}finally{_(!1)}},C=s=>t=>{const a=t.target;ue(p=>({...p,[s]:a.value}))},Ie=()=>{if(o.type==="single-running")return e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"var(--text-muted)"},children:e.jsx("i",{children:"Running task... check browser view"})});if(o.type==="error")return e.jsxs("div",{style:{color:"red",padding:"20px"},children:[o.prefix||"",o.message]});if(o.type==="single-result"){const s=o.result,t={padding:"16px",marginBottom:"16px",borderRadius:"12px",background:s.success?"#f0fdf4":"#fef2f2",border:`1px solid ${s.success?"#bbf7d0":"#fecaca"}`};return e.jsxs("div",{children:[e.jsxs("div",{style:t,children:[e.jsx("div",{style:{fontWeight:700,color:s.success?"#15803d":"#b91c1c",marginBottom:"8px"},children:s.success?"✓ 成功 (SUCCESS)":"✕ 失敗 (FAILURE)"}),e.jsx("div",{dangerouslySetInnerHTML:{__html:`<strong>Summary:</strong> ${s.summary||""}`}}),s.evaluation&&e.jsx("div",{style:{marginTop:"8px",paddingTop:"8px",borderTop:"1px dashed rgba(0,0,0,0.1)",fontSize:"0.9em"},dangerouslySetInnerHTML:{__html:`<strong>Details:</strong><br>${s.evaluation.replace(/\n/g,"<br>")}`}})]}),(s.steps||[]).map((a,p)=>e.jsx("div",{className:"wa-step",dangerouslySetInnerHTML:{__html:`<span class="wa-step-num">${a.step}.</span> ${a.content}`}},`${a.step}-${p}`))]})}if(o.type==="batch"){const s=o.batch,t=s.total||0,a=s.currentIndex||0,p=t>0?Math.max(5,Math.round(a/t*100)):0,d=s.status==="complete"?"完了":s.status==="error"?"エラー":"一括実行中",m=s.status==="complete"?`成功 ${s.successCount||0} / ${t} 件`:s.status==="error"?s.errorMessage:s.currentTaskId?`TASK ${s.currentTaskId} を実行中... (${a}/${t})`:`実行中... (${a}/${t})`,v=s.status==="complete"?e.jsxs("div",{className:"wa-batch-summary",children:[e.jsx("div",{className:"wa-batch-summary__title",children:"バッチ結果"}),e.jsxs("div",{className:"wa-batch-summary__stats",children:["成功: ",s.successCount||0," / ",t," | スコア:"," ",t?Math.round((s.successCount||0)/t*1e4)/100:0,"%",e.jsx("br",{}),"所要時間: ",s.timeText||""]})]}):null;return e.jsxs("div",{children:[v,e.jsxs("div",{className:"wa-progress-card",children:[e.jsxs("div",{className:"wa-progress-meta",children:[e.jsx("div",{className:"wa-progress-label",children:d}),e.jsxs("div",{className:"wa-progress-count",children:[e.jsx("span",{"data-progress-count":!0,children:a})," / ",t]})]}),e.jsx("div",{className:"wa-progress-bar",children:e.jsx("div",{className:`wa-progress-bar-fill${s.status==="complete"?" is-complete":s.status==="error"?" is-error":""}`,"data-progress-bar":!0,style:{width:s.status==="complete"||s.status==="error"?"100%":`${p}%`}})}),e.jsx("div",{className:"wa-progress-current","data-progress-current":!0,children:m})]}),(s.results||[]).map((g,I)=>e.jsxs("div",{className:"wa-task-result",children:[e.jsxs("div",{className:"wa-task-result__head",children:[e.jsxs("div",{className:"wa-task-result__title",children:["(",I+1,"/",t,") TASK ",g.task_id??""]}),e.jsx("span",{className:`wa-badge ${g.success?"wa-badge-success":"wa-badge-fail"}`,children:g.success?"SUCCESS":"FAIL"})]}),e.jsx("div",{className:"wa-task-result__summary",dangerouslySetInnerHTML:{__html:`<strong>Summary:</strong> ${g.summary||""}`}}),g.evaluation&&e.jsx("div",{className:"wa-task-result__evaluation",dangerouslySetInnerHTML:{__html:g.evaluation.replace(/\n/g,"<br>")}})]},g.task_id??I)),s.status==="error"&&e.jsxs("div",{className:"wa-task-result",children:[e.jsxs("div",{className:"wa-task-result__head",children:[e.jsx("div",{className:"wa-task-result__title",children:"バッチを中断しました"}),e.jsx("span",{className:"wa-badge wa-badge-fail",children:"ERROR"})]}),e.jsx("div",{className:"wa-task-result__summary",children:s.errorMessage||""})]})]})}return o.type==="blank"?null:e.jsx("p",{style:{color:"var(--text-muted)",textAlign:"center",marginTop:"20px"},children:"タスクを選択して「評価を実行」をクリックしてください。"})},H=r.useMemo(()=>{var t;if(o.type!=="single-result")return{visible:!1,text:"",className:"wa-badge"};const s=(t=o.result)==null?void 0:t.success;return{visible:!0,text:s?"SUCCESS":"FAILURE",className:`wa-badge ${s?"wa-badge-success":"wa-badge-fail"}`}},[o]),$e=l.loading?"CHECKING":l.supported?"SUPPORTED":"UNSUPPORTED",Ae=`wa-badge ${l.loading?"wa-badge-pending":l.supported?"wa-badge-success":"wa-badge-fail"}`;let j="モデルがサポートしていればスクリーンショットを送信します。";l.error?j=l.error:l.loading||(l.supported?l.effective?j="スクリーンショットをモデルに送信しています。":j="スクリーンショット送信を停止中です。":j="選択中のモデルはスクリーンショット非対応です。GPT/Gemini/Claude 系のみ対応。");const Ee=Z||oe||F,Me=F;return e.jsxs("div",{className:"wa-layout",children:[e.jsxs("aside",{className:"wa-sidebar",children:[e.jsxs("div",{className:"wa-header",children:[e.jsx("h1",{children:"WebArena Eval"}),e.jsxs("a",{href:"/",className:"wa-back-link",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M19 12H5M12 19l-7-7 7-7"})}),"ホームに戻る"]})]}),e.jsxs("div",{className:"wa-section",children:[e.jsx("h4",{className:"wa-section-title",children:"評価モデル"}),e.jsx("div",{className:"model-selector-wrapper",children:e.jsx("select",{id:"model-selector",value:i.length?ce:void 0,onChange:ke,children:i.length===0?e.jsx("option",{children:"Loading models..."}):i.map(s=>e.jsx("option",{value:k(s),children:s.label},k(s)||s.label))})})]}),e.jsxs("div",{className:"wa-section",children:[e.jsxs("div",{className:"wa-section-title",style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("span",{children:"スクリーンショット参照"}),e.jsx("span",{id:"vision-support-badge",className:Ae,children:$e})]}),e.jsxs("label",{className:"wa-toggle",children:[e.jsx("input",{type:"checkbox",id:"vision-toggle",checked:l.userEnabled,disabled:l.loading||!l.supported||de,onChange:Se}),e.jsx("span",{className:"wa-toggle-slider","aria-hidden":"true"}),e.jsx("span",{className:"wa-toggle-label",id:"vision-toggle-label",children:l.userEnabled?"ON":"OFF"})]}),e.jsx("p",{id:"vision-hint",className:"wa-hint",children:j})]}),e.jsxs("details",{className:"wa-config-details",children:[e.jsx("summary",{children:"環境設定 (Base URLs)"}),e.jsxs("div",{className:"wa-config-content",children:[e.jsxs("div",{className:"wa-input-group",children:[e.jsx("label",{children:"Shopping"}),e.jsx("input",{type:"text",id:"url-shopping",className:"wa-input",value:c.shopping,onInput:C("shopping")})]}),e.jsxs("div",{className:"wa-input-group",children:[e.jsx("label",{children:"Admin"}),e.jsx("input",{type:"text",id:"url-admin",className:"wa-input",value:c.shopping_admin,onInput:C("shopping_admin")})]}),e.jsxs("div",{className:"wa-input-group",children:[e.jsx("label",{children:"GitLab"}),e.jsx("input",{type:"text",id:"url-gitlab",className:"wa-input",value:c.gitlab,onInput:C("gitlab")})]}),e.jsxs("div",{className:"wa-input-group",children:[e.jsx("label",{children:"Reddit"}),e.jsx("input",{type:"text",id:"url-reddit",className:"wa-input",value:c.reddit,onInput:C("reddit")})]})]})]}),e.jsxs("div",{className:"wa-section",children:[e.jsx("h4",{className:"wa-section-title",children:"環境で絞り込み"}),e.jsxs("div",{id:"site-filters",style:{display:"flex",gap:"6px",flexWrap:"wrap"},children:[e.jsx("button",{className:`wa-btn-chip${h===""?" active":""}`,"data-site":"",onClick:()=>re(""),children:"ALL"}),Be.map(s=>e.jsx("button",{className:`wa-btn-chip${h===s?" active":""}`,"data-site":s,onClick:()=>re(s),children:Pe(s)},s))]})]}),e.jsxs("div",{className:"wa-section",style:{flex:1,minHeight:0,display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("h4",{className:"wa-section-title",children:"タスク一覧"}),e.jsxs("div",{className:"wa-pagination",children:[e.jsx("button",{id:"prev-page",className:"wa-btn-sm",disabled:S<=1,onClick:()=>R(s=>Math.max(s-1,1)),children:"<"}),e.jsx("span",{id:"page-indicator",style:{fontSize:"0.75rem",color:"var(--text-muted)",fontWeight:600,padding:"0 6px"},children:S}),e.jsx("button",{id:"next-page",className:"wa-btn-sm",disabled:!me,onClick:()=>R(s=>s+1),children:">"})]})]}),e.jsx("div",{id:"task-list",className:"wa-task-list",style:{overflowY:"auto",padding:"4px"},children:he?e.jsx("div",{style:{padding:"10px",color:"#94a3b8",textAlign:"center"},children:"Loading..."}):G?e.jsx("div",{style:{color:"red",padding:"10px"},children:G}):pe.map(s=>e.jsxs("div",{className:`wa-task-card${B===s.task_id&&!w?" active":""}`,"data-id":s.task_id,onClick:()=>ae(s.task_id),children:[e.jsxs("div",{className:"wa-task-id",children:["TASK ",s.task_id]}),e.jsx("div",{className:"wa-task-desc",title:s.intent,children:s.intent})]},s.task_id))}),e.jsxs("div",{className:`wa-task-card${w?" active":""}`,id:"custom-task-card",style:{marginTop:"10px",borderStyle:"dashed"},onClick:_e,children:[e.jsx("div",{className:"wa-task-id",children:"CUSTOM TASK"}),e.jsx("div",{style:{fontSize:"0.85rem",fontWeight:500},children:"カスタムタスクを実行"}),e.jsxs("div",{id:"custom-inputs",style:{marginTop:"10px",display:w?"block":"none"},children:[e.jsx("input",{type:"text",id:"custom-url",className:"wa-input",placeholder:"開始URL",style:{marginBottom:"8px"},value:q,onInput:s=>fe(s.target.value)}),e.jsx("textarea",{id:"custom-intent",className:"wa-input",rows:3,placeholder:"指示内容を入力...",value:D,onInput:s=>ve(s.target.value)})]})]})]}),e.jsxs("div",{style:{paddingTop:"10px"},children:[e.jsx("button",{id:"run-eval-btn",className:"control-button control-button--primary",style:{width:"100%",height:"46px",fontSize:"1rem",marginBottom:"8px"},disabled:Ee,onClick:Te,children:Z?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"connection-indicator","data-state":"connecting",children:e.jsx("span",{className:"dot"})}),"実行中..."]}):we}),e.jsx("button",{id:"run-batch-btn",className:"control-button",style:{width:"100%",height:"42px",fontSize:"0.95rem",border:"1px solid var(--border-subtle)"},disabled:Me,onClick:Ce,children:F?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"connection-indicator","data-state":"connecting",children:e.jsx("span",{className:"dot"})}),"一括実行中..."]}):"表示中タスクを順番に実行"}),e.jsx("div",{id:"status-msg",style:{textAlign:"center",marginTop:"8px",fontSize:"0.8rem",color:ye,minHeight:"1.2em"},children:be})]})]}),e.jsxs("main",{className:"wa-main-col",children:[e.jsx("div",{className:"wa-browser-container",children:e.jsx("iframe",{src:Re,title:"Remote Browser",style:{width:"100%",height:"100%",border:"none"}})}),e.jsxs("div",{className:"wa-results-container",children:[e.jsxs("div",{className:"wa-results-header",children:[e.jsx("h3",{children:"実行ログ / 結果"}),e.jsx("span",{id:"result-badge",className:H.className,style:{display:H.visible?"inline-flex":"none"},children:H.text})]}),e.jsx("div",{id:"logs",className:"wa-log-area",children:Ie()})]})]})]})},ie=document.getElementById("root");ie&&Oe(ie).render(e.jsx(Ue,{}));
